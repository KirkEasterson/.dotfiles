### SETTINGS ###

# change the prefix key to C-a
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# move status bar to the top
set-option -g status-position top

# start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# automatically renumber windows to always be in sequential order
set-option -g renumber-windows

# pass xterm-style key sequences
set-option -gw xterm-keys on

# no bells
set -g bell-action none

# don't rename windows automatically
set-option -g allow-rename off

# vi mode
setw -g mode-keys vi
bind-key -T copy-mode-vi y send -X copy-selection-and-cancel
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel

# turn the mouse on, but without copy mode dragging
set -g mouse on
unbind -n MouseDrag1Pane
unbind -Tcopy-mode MouseDrag1Pane

# true color settings
set -ag terminal-overrides ",xterm-256color*:Tc"

# undercurl support
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# setting title
set-option -g set-titles on
set-option -g set-titles-string '#S: #W - TMUX'

# highlight focused window
set -g pane-border-lines heavy
set -g pane-border-style "bg=default fg=grey dim"
set -g pane-active-border-style "bg=default fg=red bold" # TODO: find the gruvbox colors that work

# status line
set-option -g status-style bg=colour237,fg=colour223
set-window-option -g window-status-style bg=colour214,fg=colour237
set -g status-left-length 20
set-option -g status-left "#[bg=colour241,fg=colour248] \[#S\] "
set-option -g status-right ""
set-window-option -g window-status-current-format "#[bg=colour214,fg=colour239] #I\:#[bg=colour214,fg=colour239,bold]#W#{?window_zoomed_flag,*Z,} "
set-window-option -g window-status-format "#[bg=colour239,fg=colour223] #I\:#[bg=colour239,fg=colour223]#W "


### SESSIONS ###

# rename session
bind M-z command-prompt -I "rename-session "

# browser-like bindings
bind M-t new-session
bind M-w kill-session
# bind M-Tab switch-client -n
# bind M-S-Tab switch-client -p


## WINDOWS ##

# higher order windows
bind F1 selectw -t:11
bind F2 selectw -t:12
bind F3 selectw -t:13
bind F4 selectw -t:14
bind F5 selectw -t:15
bind F6 selectw -t:16
bind F7 selectw -t:17
bind F8 selectw -t:18
bind F9 selectw -t:19
bind F10 selectw -t:20
bind F11 selectw -t:21
bind F12 selectw -t:22

# a key to toggle between smallest and largest sizes if a window is visible in
# multiple places
bind F set -w window-size

# rename window
bind C-z command-prompt -I "rename-window "

# browser-like bindings
bind C-t new-window -c '#(pane_current_path)'
bind C-w killp


## PANES ##

# navigating windows
bind C-S-H swap-pane -D
bind C-S-J swap-pane -D
bind C-S-K swap-pane -U
bind C-S-L swap-pane -U


# keys to toggle monitoring activity in a window and the synchronize-panes option
bind m set monitor-activity
bind p set synchronize-panes\; display 'synchronize-panes #{?synchronize-panes,on,off}'

## PLUGINS ##

# install TPM if not installed
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'mkdir -p ~/.config/tmux/plugins && git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

set -g @plugin 'tmux-plugins/tpm' # tmux plugin manager
set -g @plugin 'tmux-plugins/tmux-sensible' # sensible settings and bindings
set -g @plugin 'tmux-plugins/tmux-resurrect' # saving state of tmux
set -g @plugin 'tmux-plugins/tmux-continuum' # automatically restore saved states
set -g @plugin 'tmux-plugins/tmux-pain-control' # better control of tmux panes
set -g @plugin 'christoomey/vim-tmux-navigator' # navigating within tmux and vim
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-sidebar'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

# vim-tmux-navigator resize bindings
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n 'M-h' if-shell "$is_vim" 'send-keys M-h' 'resize-pane -L 8'
bind -n 'M-j' if-shell "$is_vim" 'send-keys M-j' 'resize-pane -D 4'
bind -n 'M-k' if-shell "$is_vim" 'send-keys M-k' 'resize-pane -U 4'
bind -n 'M-l' if-shell "$is_vim" 'send-keys M-l' 'resize-pane -R 8'

bind-key -T copy-mode-vi M-h resize-pane -L 1
bind-key -T copy-mode-vi M-j resize-pane -D 1
bind-key -T copy-mode-vi M-k resize-pane -U 1
bind-key -T copy-mode-vi M-l resize-pane -R 1

# tmux tree
set -g @sidebar-tree-position 'right'
unbind t
set -g @sidebar-tree 't'
set -g @sidebar-tree-command 'exa --color=always --group-directories-first --icons --tree --level=2'

# restore neovim sessions with tmux-resurrect
set -g @resurrect-strategy-nvim 'session'

# Add 'clear' feature with prefix, since vim-tmux-navigator overwrites the default keybinding
bind C-l send-keys 'C-l'

# use tmux-fzf for sessions switching
unbind s
bind s run-shell -b "~/.config/tmux/plugins/tmux-fzf/scripts/session.sh switch"

# prefix highlighting
set -g status-right '#{prefix_highlight}'
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_show_sync_mode 'on'
set -g @prefix_highlight_prefix_prompt 'TMUX'
set -g @prefix_highlight_copy_prompt 'Copy'
set -g @prefix_highlight_sync_prompt 'Sync'

# initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
